<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è®°å¿†å¡ç‰‡</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Vue 3 å›½å†…CDN -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.4.21/vue.global.prod.min.js"></script>
    <!-- Axios å›½å†…CDN -->
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.8/axios.min.js"></script>
    <!-- Element Plus å›½å†…CDN -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/element-plus/2.6.2/index.min.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/element-plus/2.6.2/index.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f7f7f7; }
        .container { max-width: 1300px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
        h1 { text-align: center; }
        .card { margin: 20px 0; padding: 20px; border: 1px solid #eee; border-radius: 6px; background: #fafafa; }
        .btn { padding: 8px 18px; border: none; border-radius: 4px; background: #007bff; color: #fff; cursor: pointer; }
        .btn:disabled { background: #aaa; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .main-flex-row {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: nowrap;
        }
        @media (max-width: 1100px) {
            .main-flex-row { flex-wrap: wrap; }
        }
        @media (max-width: 900px) {
            .main-flex-row { display: block; }
        }
    </style>
</head>
<body>
<div id="app">
    <!-- å·¦ä¸Šè§’ä¿¡æ¯æ  -->
    <div style="position:fixed;left:30px;top:20px;z-index:1000;background:rgba(255,255,255,0.95);padding:12px 24px;border-radius:8px;box-shadow:0 2px 8px #eee;min-width:180px;">
        <div style="font-size:16px;">ğŸ•’ æ—¶é—´ï¼š{{ currentTime }}</div>
        <div style="font-size:16px;margin-top:4px;">ğŸ“¦ å¡ç‰‡æ•°ï¼š{{ cardCount }}</div>
    </div>
    <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
    <el-dialog v-model="imgPreviewVisible" width="auto" :show-close="true" top="10vh" center>
        <img :src="imgPreviewUrl" alt="é¢„è§ˆå›¾ç‰‡" style="max-width:80vw;max-height:70vh;display:block;margin:auto;" />
    </el-dialog>
    <div class="container" v-if="!isLoggedIn">
        <el-card shadow="hover">
            <h1>è®°å¿†å¡ç‰‡</h1>
            <div class="welcome">
                <h2>è¯·å…ˆç™»å½•</h2>
            </div>
            <el-form :model="loginForm" @submit.native.prevent="login" label-width="80px" style="max-width:400px;margin:auto;">
                <el-form-item label="ç”¨æˆ·å">
                    <el-input v-model="loginForm.username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required></el-input>
                </el-form-item>
                <el-form-item label="å¯†ç ">
                    <el-input v-model="loginForm.password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " required show-password></el-input>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" native-type="submit" style="width:100%;font-size:18px;">ç™»å½•</el-button>
                </el-form-item>
                <el-form-item v-if="loginMsg">
                    <el-alert :title="loginMsg" type="error" show-icon></el-alert>
                </el-form-item>
            </el-form>
        </el-card>
    </div>
    <div class="container" v-else>
        <h1 style="text-align:center;">è®°å¿†å¡ç‰‡</h1>
        <el-button type="danger" @click="logout" style="float:right;margin-top:-50px;">ç™»å‡º</el-button>
        <div class="main-flex-row">
            <!-- æ·»åŠ çŸ¥è¯†ç‚¹ -->
            <el-card style="flex:1 1 0;min-width:320px;max-width:400px;margin-bottom:0;" shadow="hover">
                <h2 style="text-align:center; color:#007bff;">ä»Šå¤©æƒ³æ·»åŠ ä»€ä¹ˆçŸ¥è¯†ç‚¹ï¼Ÿ</h2>
                <el-form :model="addForm" @submit.native.prevent="addCard" label-width="60px" style="margin:20px auto 0 auto;">
                    <el-form-item label="æ ‡é¢˜">
                        <el-input v-model="addForm.title" required placeholder="è¯·è¾“å…¥å¡ç‰‡æ ‡é¢˜"></el-input>
                    </el-form-item>
                    <el-form-item label="å†…å®¹">
                        <el-input type="textarea" v-model="addForm.content" :rows="3" required placeholder="è¯·è¾“å…¥å¡ç‰‡å†…å®¹"></el-input>
                    </el-form-item>
                    <el-form-item label="æ ‡ç­¾">
                        <el-input v-model="addForm.tags" placeholder="å¦‚ï¼šè‹±è¯­,æ•°å­¦,ç¼–ç¨‹"></el-input>
                    </el-form-item>
                    <el-form-item label="å›¾ç‰‡é“¾æ¥">
                        <el-input v-model="addForm.img" placeholder="æ”¯æŒjpgç½‘ç»œå›¾ç‰‡é“¾æ¥"></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" native-type="submit" style="width:100%;font-size:18px;">æ·»åŠ çŸ¥è¯†ç‚¹</el-button>
                    </el-form-item>
                    <el-form-item v-if="addMsg">
                        <el-alert :title="addMsg" type="success" show-icon></el-alert>
                    </el-form-item>
                </el-form>
                <!-- æ ‡ç­¾å¿«é€Ÿæ·»åŠ  -->
                <div v-if="Object.keys(byTag).length" style="margin:10px 0 0 0;">
                    <span style="font-size:14px;color:#888;">ç‚¹å‡»æ ‡ç­¾å¿«é€Ÿæ·»åŠ ï¼š</span>
                    <el-tag v-for="tag in Object.keys(byTag)" :key="tag" style="margin:0 4px 4px 0;cursor:pointer;" @click="addTagToInput(tag)">{{ tag }}</el-tag>
                </div>
            </el-card>
            <!-- ä»Šæ—¥æŠ½å¡ -->
            <el-card style="flex:1 1 0;min-width:320px;max-width:400px;margin-bottom:0;" shadow="hover">
                <h2 style="text-align:center; color:#28a745;">ä»Šæ—¥ä»½çš„æŠ½å¡ï¼</h2>
                <div style="text-align:center;">
                    <el-button type="primary" @click="drawCard" style="font-size:18px;">æŠ½å¡</el-button>
                </div>
                <div id="card-area" style="margin-top:20px;">
                    <div v-if="drawnCard">
                        <el-card class="card">
                            <strong>{{ drawnCard.title }}</strong>
                            <span v-if="drawnCard.tags && drawnCard.tags.length">
                                <el-tag v-for="tag in drawnCard.tags" :key="tag" style="margin-left:6px;vertical-align:middle;">{{ tag }}</el-tag>
                            </span><br>
                            <el-button type="info" @click="revealContent = !revealContent" v-if="!revealContent">æ˜¾ç¤ºå†…å®¹</el-button>
                            <div v-if="revealContent">
                                <hr>
                                <div v-if="drawnCard.content">{{ drawnCard.content }}</div>
                                <div v-if="drawnCard.img">
                                    <img :src="drawnCard.img" alt="å¡ç‰‡å›¾ç‰‡" style="max-width:100%;max-height:120px;margin:8px 0;border-radius:6px;box-shadow:0 1px 4px #ccc;cursor:pointer;" @click="showImgPreview(drawnCard.img)" />
                                </div>
                                <el-button type="success" @click="reviewCard('remember')">è®°ä½</el-button>
                                <el-button type="warning" @click="reviewCard('forget')">å¿˜è®°</el-button>
                                <div style="margin-top:10px;">
                                    <el-alert v-if="reviewMsg" :title="reviewMsg" type="success" show-icon></el-alert>
                                </div>
                            </div>
                        </el-card>
                    </div>
                    <div v-else-if="drawMsg">
                        <el-alert :title="drawMsg" type="info" show-icon></el-alert>
                    </div>
                </div>
            </el-card>
            <!-- æ˜¾ç¤ºæ‰€æœ‰çŸ¥è¯†ç‚¹ -->
            <el-card style="flex:1 1 0;min-width:320px;max-width:400px;margin-bottom:0;" shadow="hover">
                <h2 style="text-align:center; color:#ff9800;">æ˜¾ç¤ºæˆ‘çš„æ‰€æœ‰çŸ¥è¯†ç‚¹</h2>
                <div style="text-align:center;">
                    <el-button v-if="!showAllCards" type="primary" @click="fetchAllCardsAndShow" style="font-size:18px;">æ˜¾ç¤ºæ‰€æœ‰çŸ¥è¯†ç‚¹</el-button>
                    <el-button v-else type="info" @click="hideAllCards" style="font-size:18px;">æ”¶èµ·æ‰€æœ‰çŸ¥è¯†ç‚¹</el-button>
                </div>
                <div v-if="showAllCards">
                    <div id="tag-filter-area" style="margin:10px 0;">
                        <span v-if="Object.keys(byTag).length">
                            <strong>æŒ‰æ ‡ç­¾ç­›é€‰ï¼š</strong>
                            <el-tag v-for="tag in Object.keys(byTag)" :key="tag" @click="filterByTag(tag)" style="margin:0 4px;cursor:pointer;">{{ tag }}</el-tag>
                            <el-tag v-if="tagFilter" type="danger" @click="filterByTag('')" style="margin-left:8px;cursor:pointer;">æ¸…é™¤ç­›é€‰</el-tag>
                        </span>
                    </div>
                    <div v-if="allCards.length">
                        <el-card class="card" v-for="card in filteredCards" :key="card.id" style="margin-bottom:12px;">
                            <strong>æ ‡é¢˜ï¼š</strong><span class="card-title">{{ card.title }}</span><br>
                            <strong>å†…å®¹ï¼š</strong><span class="card-content">{{ card.content }}</span><br>
                            <strong>å›¾ç‰‡ï¼š</strong>
                            <div v-if="card.img">
                                <img :src="card.img" alt="å¡ç‰‡å›¾ç‰‡" style="max-width:100%;max-height:120px;margin:8px 0;border-radius:6px;box-shadow:0 1px 4px #ccc;cursor:pointer;" @click="showImgPreview(card.img)" />
                            </div>
                            <strong>æ ‡ç­¾ï¼š</strong>
                            <span class="card-tags">
                                <el-tag v-for="tag in (card.tags||[])" :key="tag" size="small" style="margin-right:4px;">{{ tag }}</el-tag>
                            </span><br>
                            <el-button size="small" type="primary" @click="startEdit(card)">ç¼–è¾‘</el-button>
                            <el-button size="small" type="danger" @click="deleteCard(card.id)">åˆ é™¤</el-button>
                            <div class="edit-form-area" v-if="editId === card.id" style="margin-top:10px;">
                                <el-form :model="editForm" @submit.native.prevent="submitEdit(card.id)" label-width="40px">
                                    <el-form-item label="æ ‡é¢˜">
                                        <el-input v-model="editForm.title" required></el-input>
                                    </el-form-item>
                                    <el-form-item label="å†…å®¹">
                                        <el-input type="textarea" v-model="editForm.content" :rows="3" required></el-input>
                                    </el-form-item>
                                    <el-form-item label="æ ‡ç­¾">
                                        <el-input v-model="editForm.tags"></el-input>
                                    </el-form-item>
                                    <el-form-item label="å›¾ç‰‡é“¾æ¥">
                                        <el-input v-model="editForm.img" placeholder="æ”¯æŒjpgç½‘ç»œå›¾ç‰‡é“¾æ¥"></el-input>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-button type="success" native-type="submit">ä¿å­˜</el-button>
                                        <el-button @click="cancelEdit">å–æ¶ˆ</el-button>
                                    </el-form-item>
                                </el-form>
                            </div>
                        </el-card>
                    </div>
                    <el-alert v-else :closable="false" type="info" show-icon>æš‚æ— å¡ç‰‡ï¼Œè¯·å…ˆæ·»åŠ ï¼</el-alert>
                </div>
            </el-card>
        </div>
    </div>
</div>
<script>
const { createApp } = Vue;
const app = createApp({
    data() {
        return {
            isLoggedIn: false,
            loginForm: { username: '', password: '' },
            loginMsg: '',
            addForm: { title: '', content: '', tags: '', img: '' },
            addMsg: '',
            drawnCard: null,
            revealContent: false,
            drawMsg: '',
            reviewMsg: '',
            allCards: [],
            allMsg: '',
            byTag: {},
            tagFilter: '',
            editId: null,
            editForm: { title: '', content: '', tags: '', img: '' },
            currentTime: '',
            imgPreviewVisible: false,
            imgPreviewUrl: '',
            showAllCards: false,
            cardCount: 0,
        };
    },
    computed: {
        filteredCards() {
            if (!this.tagFilter) return this.allCards;
            return this.allCards.filter(card => (card.tags || []).includes(this.tagFilter));
        }
    },
    mounted() {
        this.checkLogin();
        this.fetchTagsOnly(); // é¡µé¢åŠ è½½æ—¶åªè·å–æ ‡ç­¾é›†åˆ
        this.updateTime();
        setInterval(this.updateTime, 1000);
    },
    methods: {
        updateTime() {
            const now = new Date();
            const pad = n => n.toString().padStart(2, '0');
            this.currentTime = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
        },
        checkLogin() {
            axios.get('/all_cards').then(() => {
                this.isLoggedIn = true;
                this.loginMsg = '';
                this.fetchTagsOnly(); // ç™»å½•æˆåŠŸååªè·å–æ ‡ç­¾é›†åˆ
            }).catch(() => {
                this.isLoggedIn = false;
            });
        },
        login() {
            this.loginMsg = '';
            axios.post('/login', this.loginForm).then(res => {
                if (res.data.success) {
                    this.isLoggedIn = true;
                    this.loginForm.password = '';
                } else {
                    this.loginMsg = res.data.message;
                }
            });
        },
        logout() {
            axios.post('/logout').then(() => {
                this.isLoggedIn = false;
                this.loginForm.password = '';
            });
        },
        addCard() {
            this.addMsg = '';
            const form = new FormData();
            form.append('title', this.addForm.title);
            form.append('content', this.addForm.content);
            form.append('tags', this.addForm.tags);
            form.append('img', this.addForm.img);
            axios.post('/add', form).then(() => {
                this.addMsg = 'æ·»åŠ æˆåŠŸï¼';
                this.addForm = { title: '', content: '', tags: '', img: '' };
                setTimeout(() => { this.addMsg = ''; }, 1500);
            });
        },
        drawCard() {
            this.drawnCard = null;
            this.revealContent = false;
            this.drawMsg = '';
            axios.get('/draw').then(res => {
                if (res.data.success) {
                    // éœ€è¦è·å–å®Œæ•´å¡ç‰‡å†…å®¹å’Œå›¾ç‰‡
                    axios.get('/all_cards').then(allRes => {
                        if (allRes.data.success && allRes.data.cards.length) {
                            const card = allRes.data.cards.find(c => c.id === res.data.id);
                            if (card) {
                                this.drawnCard = card;
                            } else {
                                this.drawnCard = { id: res.data.id, title: res.data.title };
                            }
                        } else {
                            this.drawnCard = { id: res.data.id, title: res.data.title };
                        }
                    });
                } else {
                    this.drawMsg = res.data.message;
                }
            });
        },
        reviewCard(result) {
            axios.post(`/review/${this.drawnCard.id}`, { result }).then(res => {
                this.reviewMsg = res.data.message;
                setTimeout(() => {
                    this.reviewMsg = '';
                    this.drawCard();
                }, 1000);
            });
        },
        fetchAllCards() {
            this.allMsg = '';
            this.allCards = [];
            axios.get('/all_cards').then(res => {
                if (res.data.success && res.data.cards.length) {
                    this.allCards = res.data.cards;
                    this.cardCount = res.data.cards.length;
                }
            });
        },
        fetchAllCardsAndShow() {
            this.fetchAllCards();
            this.showAllCards = true;
        },
        hideAllCards() {
            this.showAllCards = false;
            this.allCards = [];
        },
        fetchTagsOnly() {
            axios.get('/all_cards').then(res => {
                const cards = res.data.cards || [];
                const byTag = {};
                cards.forEach(card => {
                    (card.tags || []).forEach(tag => {
                        if (tag) byTag[tag] = byTag[tag] ? byTag[tag] + 1 : 1;
                    });
                });
                this.byTag = byTag;
                this.cardCount = cards.length;
            });
        },
        filterByTag(tag) {
            this.tagFilter = tag;
            this.allMsg = '';
            this.allCards = [];
            axios.get('/all_cards', { params: { tag } }).then(res => {
                if (res.data.success && res.data.cards.length) {
                    this.allCards = res.data.cards;
                } else {
                    this.allMsg = 'è¯¥æ ‡ç­¾ä¸‹æš‚æ— å¡ç‰‡ï¼';
                }
            });
        },
        clearTagFilter() {
            this.tagFilter = '';
            this.fetchAllCards();
        },
        deleteCard(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å¡ç‰‡å—ï¼Ÿ')) return;
            axios.delete(`/delete_card/${id}`).then(res => {
                if (res.data.success) {
                    this.fetchAllCards();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + (res.data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        },
        startEdit(card) {
            this.editId = card.id;
            this.editForm = {
                title: card.title,
                content: card.content,
                tags: (card.tags || []).join(', '),
                img: card.img || ''
            };
        },
        cancelEdit() {
            this.editId = null;
        },
        submitEdit(id) {
            const tags = this.editForm.tags.split(',').map(t=>t.trim()).filter(t=>t);
            axios.post(`/edit_card/${id}`, {
                title: this.editForm.title,
                content: this.editForm.content,
                tags,
                img: this.editForm.img
            }).then(res => {
                if (res.data.success) {
                    this.editId = null;
                    this.fetchAllCards();
                } else {
                    alert('ä¿®æ”¹å¤±è´¥ï¼š' + (res.data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        },
        showImgPreview(url) {
            this.imgPreviewUrl = url;
            this.imgPreviewVisible = true;
        },
        addTagToInput(tag) {
            let tagsArr = this.addForm.tags.split(',').map(t => t.trim()).filter(t => t);
            if (!tagsArr.includes(tag)) {
                tagsArr.push(tag);
                this.addForm.tags = tagsArr.join(', ');
            }
        }
    }
});
app.use(ElementPlus);
app.mount('#app');
</script>